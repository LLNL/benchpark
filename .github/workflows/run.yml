name: Run Benchpark and Simple Benchmark Suite
on:
  # This Workflow can be triggered manually
  workflow_dispatch:
  workflow_call:

jobs:
  saxpy:
    runs-on: ubuntu-latest
    steps:
      - name: Remove gcc > 12 # to prevent Spack from picking a gcc without gfortan
        run: |
          sudo apt-get remove -y gcc-13

      - name: Checkout Benchpark
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11

      - name: Build Saxpy Workspace
        run: |
          ./bin/benchpark setup saxpy/openmp x86 workspace/

      - name: Setup Ramble & Spack
        run: |
          export SPACK_DISABLE_LOCAL_CONFIG=1
          . workspace/saxpy/openmp/x86/spack/share/spack/setup-env.sh
          . workspace/saxpy/openmp/x86/ramble/share/ramble/setup-env.sh
          env | grep SPACK >> "$GITHUB_ENV"
          env | grep SPACK >> "$GITHUB_ENV"
          echo "PATH=$PATH" >> "$GITHUB_ENV"

      - name: Setup Saxpy Workspace
        run: |
          cd workspace/saxpy/openmp/x86/workspace/
          ramble --workspace-dir . --disable-progress-bar --disable-logger workspace setup

      - name: Run Saxpy Experiments
        run: |
          cd workspace/saxpy/openmp/x86/workspace/
          ramble --workspace-dir . --disable-progress-bar --disable-logger on

      - name: Analyze Saxpy Results
        run: |
          cd workspace/saxpy/openmp/x86/workspace/
          ramble --workspace-dir . --disable-progress-bar --disable-logger workspace analyze
